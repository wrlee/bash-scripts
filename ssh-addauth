#!
## Add specified .pub key to remote server

while getopts "i:h?" OPTNAME "$@"; do
#	echo OPTNAME=$OPTNAME OPTARG=$OPTARG OPTIND=$OPTIND
	case "$OPTNAME" in
      i)
		 if [ ! -f "$OPTARG" ]; then
			echo -e "${t_red}\"$OPTARG\" does not exist.${t_reset}"
		 	exit 
		 fi
         __KEY=-i "$OPTARG"
		 ;;
      h|?)
		__HELP=1
		;;
      *)
		echo -e "${t_red}Unexpected result from getopts.${t_reset}"
		break
		;;
	esac
done
shift $(($OPTIND-1))

if [ $# -lt 1 -o -n "$__HELP" ]; then
	cat <<-ENDHERE
	
	Adds specified .pub keys to remote server.

	Form:
		$0 [ -i priv_key.pem ] remote public_key_file...

ENDHERE
	exit 24
fi

if [ $# -gt 1 ]; then 
	remote=$1
	shift
fi
pubkey=$1
if [ ! -r "$pubkey" ]; then
	echo "\"$pubkey\" not found."
	return 28
fi

if [ -n "$remote" -a ! "$remote" = "." ]; then
	## Append public key to remote's allowed keys.
	ssh $_KEY $remote "cat >>.ssh/authorized_keys" < "$pubkey"  
	## Copy key to remote
	scp $_KEY -p "$pubkey" $remote:.ssh
else
	cat "$pubkey">>~/.ssh/authorized_keys
fi
